<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: right;
            border: 1px solid #ddd;
        }

        .products-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .products-table tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stat-card h4 {
            font-size: 1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .orders-table th,
        .orders-table td {
            padding: 15px;
            text-align: right;
            border: 1px solid #ddd;
        }

        .orders-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .badge-online {
            background: #28a745;
            color: white;
        }

        .badge-friends {
            background: #6f42c1;
            color: white;
        }

        .badge-store {
            background: #007bff;
            color: white;
        }

        .badge-wholesale {
            background: #ffc107;
            color: #333;
        }

        .badge-consignment {
            background: #17a2b8;
            color: white;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            margin-top: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-item h5 {
            font-size: 0.9em;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .summary-item .amount {
            font-size: 1.5em;
            font-weight: bold;
        }

        .action-buttons {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</h1>
            <p>Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙˆØ§Ù„Ù…Ø­Ù„Ø§Øª</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="window.switchTab('new-order')">â• Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯</button>
            <button class="tab" onclick="window.switchTab('orders-list')">ğŸ“‹ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</button>
            <button class="tab" onclick="window.switchTab('statistics')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        </div>

        <div class="content">
            <!-- ØªØ§Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ -->
            <div id="new-order" class="tab-content active">
                <form id="orderForm">
                    <div class="form-section">
                        <h3>ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                                <input type="text" id="orderNumber" readonly>
                            </div>
                            <div class="form-group">
                                <label>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                                <input type="datetime-local" id="orderDate" required>
                            </div>
                            <div class="form-group">
                                <label>Ù†ÙˆØ¹ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                                <select id="orderType" required onchange="handleOrderTypeChange()">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="friends">ØªØ³Ù„ÙŠÙ… Ù„Ù…Ø¹Ø§Ø±Ù</option>
                                    <option value="online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ÙˆÙŠØ¨ Ø³Ø§ÙŠØª</option>
                                    <option value="store">Ù…Ø­Ù„</option>
                                </select>
                            </div>
                            <div class="form-group" id="saleMethodGroup" style="display:none;">
                                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹ (Ù„Ù„Ù…Ø­Ù„ ÙÙ‚Ø·)</label>
                                <select id="saleMethod" onchange="toggleCommission()">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</option>
                                    <option value="wholesale">Ø¬Ù…Ù„Ø©</option>
                                    <option value="consignment">Ø£Ù…Ø§Ù†Ø©</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ù…Ø­Ù„</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group hidden" id="commissionGroup">
                                <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (%)</label>
                                <input type="number" id="commissionRate" min="0" max="100" step="0.1" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                                <input type="text" id="productName">
                            </div>
                            <div class="form-group">
                                <label>Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                                <input type="number" id="productPrice" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>ØªÙƒÙ„ÙØ© Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                                <input type="number" id="productCost" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                <input type="number" id="productQuantity" min="1" value="1">
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addProduct()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
                        
                        <table class="products-table" id="productsTable" style="display:none;">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody"></tbody>
                        </table>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
                        <div class="form-group">
                            <textarea id="notes" rows="3" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                        </div>
                    </div>

                    <div class="summary-section" id="orderSummary" style="display:none;">
                        <h3>ğŸ’° Ù…Ù„Ø®Øµ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±</h5>
                                <div class="amount" id="totalPrice">0</div>
                            </div>
                            <div class="summary-item">
                                <h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</h5>
                                <div class="amount" id="totalCost">0</div>
                            </div>
                            <div class="summary-item hidden" id="commissionAmountGroup">
                                <h5>Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø­Ù„</h5>
                                <div class="amount" id="commissionAmount">0</div>
                            </div>
                            <div class="summary-item hidden" id="netAmountGroup">
                                <h5>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</h5>
                                <div class="amount" id="netAmount">0</div>
                            </div>
                            <div class="summary-item">
                                <h5>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h5>
                                <div class="amount" id="netProfit">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-success">âœ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</button>
                        <button type="button" class="btn btn-danger" onclick="resetForm()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                        <button type="button" class="btn btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    </div>
                </form>
            </div>

            <!-- ØªØ§Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª -->
            <div id="orders-list" class="tab-content">
                <div class="filters">
                    <h3>ğŸ” Ø§Ù„ÙÙ„Ø§ØªØ±</h3>
                    <div class="filters-grid">
                        <div class="form-group">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                            <select id="filterOrderType" onchange="filterOrders()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="friends">ØªØ³Ù„ÙŠÙ… Ù„Ù…Ø¹Ø§Ø±Ù</option>
                                <option value="online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</option>
                                <option value="store">Ù…Ø­Ù„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹</label>
                            <select id="filterSaleMethod" onchange="filterOrders()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="wholesale">Ø¬Ù…Ù„Ø©</option>
                                <option value="consignment">Ø£Ù…Ø§Ù†Ø©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="filterDateFrom" onchange="filterOrders()">
                        </div>
                        <div class="form-group">
                            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="filterDateTo" onchange="filterOrders()">
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹</th>
                                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…Ø­Ù„</th>
                                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ØªØ§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div id="statistics" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</h4>
                        <div class="value" id="statTotalOrders">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸ‘¥ ØªØ³Ù„ÙŠÙ… Ù„Ù…Ø¹Ø§Ø±Ù</h4>
                        <div class="value" id="statFriendsOrders">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸŒ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</h4>
                        <div class="value" id="statOnlineOrders">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸª Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù„</h4>
                        <div class="value" id="statStoreOrders">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h4>
                        <div class="value" id="statTotalSales">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h4>
                        <div class="value" id="statTotalProfit">0</div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª (Ø¬Ù…Ù„Ø© vs Ø£Ù…Ø§Ù†Ø©)</h3>
                    <div class="stats-grid">
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <h4>Ù…Ø­Ù„ - Ø¬Ù…Ù„Ø©</h4>
                            <div class="value" id="statStoreWholesale">0</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <h4>Ù…Ø­Ù„ - Ø£Ù…Ø§Ù†Ø©</h4>
                            <div class="value" id="statStoreConsignment">0</div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ’µ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¬Ù…Ù„Ø©</h4>
                            <div class="value" id="statWholesaleProfit">0</div>
                        </div>
                        <div class="stat-card">
                            <h4>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø£Ù…Ø§Ù†Ø©</h4>
                            <div class="value" id="statConsignmentProfit">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let orders = [];
        let currentProducts = [];
        let orderCounter = 1;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        async function loadData() {
            try {
                const ordersData = await window.storage.get('orders_data');
                if (ordersData && ordersData.value) {
                    const data = JSON.parse(ordersData.value);
                    orders = data.orders || [];
                    orderCounter = data.orderCounter || 1;
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                }
            } catch (error) {
                console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹');
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†
        async function saveData() {
            try {
                const data = {
                    orders: orders,
                    orderCounter: orderCounter,
                    lastUpdated: new Date().toISOString()
                };
                await window.storage.set('orders_data', JSON.stringify(data));
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        function generateOrderNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const counter = String(orderCounter).padStart(4, '0');
            return `ORD-${year}${month}${day}-${counter}`;
        }

        function initializeForm() {
            document.getElementById('orderNumber').value = generateOrderNumber();
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('orderDate').value = now.toISOString().slice(0, 16);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù†Ø´Ø·
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes('Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯') && tabName === 'new-order') {
                    tab.classList.add('active');
                } else if (tab.textContent.includes('Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª') && tabName === 'orders-list') {
                    tab.classList.add('active');
                } else if (tab.textContent.includes('Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª') && tabName === 'statistics') {
                    tab.classList.add('active');
                }
            });
            
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'orders-list') {
                displayOrders();
            } else if (tabName === 'statistics') {
                updateStatistics();
            }
        }

        function handleOrderTypeChange() {
            const orderType = document.getElementById('orderType').value;
            const saleMethodGroup = document.getElementById('saleMethodGroup');
            const saleMethod = document.getElementById('saleMethod');
            const commissionGroup = document.getElementById('commissionGroup');
            
            if (orderType === 'store') {
                saleMethodGroup.style.display = 'block';
                saleMethod.required = true;
            } else {
                saleMethodGroup.style.display = 'none';
                saleMethod.required = false;
                saleMethod.value = '';
                commissionGroup.classList.add('hidden');
                document.getElementById('commissionRate').value = 0;
            }
            
            calculateOrderSummary();
        }

        window.toggleCommission = function() {
            const saleMethod = document.getElementById('saleMethod').value;
            const commissionGroup = document.getElementById('commissionGroup');
            
            if (saleMethod === 'consignment') {
                commissionGroup.classList.remove('hidden');
            } else {
                commissionGroup.classList.add('hidden');
                document.getElementById('commissionRate').value = 0;
            }
            
            calculateOrderSummary();
        }

        window.addProduct = function() {
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const cost = parseFloat(document.getElementById('productCost').value) || 0;
            const quantity = parseInt(document.getElementById('productQuantity').value) || 0;

            if (!name || price <= 0 || cost <= 0 || quantity <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }

            const product = {
                name,
                price,
                cost,
                quantity,
                total: price * quantity
            };

            currentProducts.push(product);
            displayProducts();
            clearProductFields();
            calculateOrderSummary();
        }

        function displayProducts() {
            const tbody = document.getElementById('productsTableBody');
            const table = document.getElementById('productsTable');
            
            tbody.innerHTML = '';
            
            currentProducts.forEach((product, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.price.toFixed(2)}</td>
                    <td>${product.cost.toFixed(2)}</td>
                    <td>${product.quantity}</td>
                    <td>${product.total.toFixed(2)}</td>
                    <td><button class="btn btn-danger" onclick="removeProduct(${index})">Ø­Ø°Ù</button></td>
                `;
            });
            
            table.style.display = currentProducts.length > 0 ? 'table' : 'none';
        }

        window.removeProduct = function(index) {
            currentProducts.splice(index, 1);
            displayProducts();
            calculateOrderSummary();
        }

        function clearProductFields() {
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productQuantity').value = '1';
        }

        function calculateOrderSummary() {
            if (currentProducts.length === 0) {
                document.getElementById('orderSummary').style.display = 'none';
                return;
            }

            const orderType = document.getElementById('orderType').value;
            const saleMethod = document.getElementById('saleMethod').value;
            const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0;

            let totalPrice = 0;
            let totalCost = 0;

            currentProducts.forEach(product => {
                totalPrice += product.price * product.quantity;
                totalCost += product.cost * product.quantity;
            });

            let commissionAmount = 0;
            let netAmount = totalPrice;

            // Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø­Ù„ + Ø£Ù…Ø§Ù†Ø©
            if (orderType === 'store' && saleMethod === 'consignment') {
                commissionAmount = totalPrice * (commissionRate / 100);
                netAmount = totalPrice - commissionAmount;
            }

            const netProfit = netAmount - totalCost;

            document.getElementById('totalPrice').textContent = totalPrice.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡';
            document.getElementById('totalCost').textContent = totalCost.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡';
            document.getElementById('commissionAmount').textContent = commissionAmount.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡';
            document.getElementById('netAmount').textContent = netAmount.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡';
            document.getElementById('netProfit').textContent = netProfit.toFixed(2) + ' Ø¬Ù†ÙŠÙ‡';

            if (orderType === 'store' && saleMethod === 'consignment') {
                document.getElementById('commissionAmountGroup').classList.remove('hidden');
                document.getElementById('netAmountGroup').classList.remove('hidden');
            } else {
                document.getElementById('commissionAmountGroup').classList.add('hidden');
                document.getElementById('netAmountGroup').classList.add('hidden');
            }

            document.getElementById('orderSummary').style.display = 'block';
        }

        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (currentProducts.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            const orderType = document.getElementById('orderType').value;
            const saleMethod = document.getElementById('saleMethod').value;
            const commissionRate = parseFloat(document.getElementById('commissionRate').value) || 0;

            let totalPrice = 0;
            let totalCost = 0;

            currentProducts.forEach(product => {
                totalPrice += product.price * product.quantity;
                totalCost += product.cost * product.quantity;
            });

            let commissionAmount = 0;
            let netAmount = totalPrice;

            // Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙÙ‚Ø· Ù„Ù„Ù…Ø­Ù„ + Ø£Ù…Ø§Ù†Ø©
            if (orderType === 'store' && saleMethod === 'consignment') {
                commissionAmount = totalPrice * (commissionRate / 100);
                netAmount = totalPrice - commissionAmount;
            }

            const order = {
                orderNumber: document.getElementById('orderNumber').value,
                orderDate: document.getElementById('orderDate').value,
                orderType: orderType,
                saleMethod: orderType === 'store' ? saleMethod : null,
                customerName: document.getElementById('customerName').value,
                commissionRate: commissionRate,
                products: [...currentProducts],
                notes: document.getElementById('notes').value,
                totalPrice: totalPrice,
                totalCost: totalCost,
                commissionAmount: commissionAmount,
                netAmount: netAmount,
                netProfit: netAmount - totalCost
            };

            orders.push(order);
            orderCounter++;
            
            await saveData(); // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¨Ù†Ø¬Ø§Ø­!');
            resetForm();
        });

        window.resetForm = function() {
            document.getElementById('orderForm').reset();
            currentProducts = [];
            displayOrders();
            document.getElementById('orderSummary').style.display = 'none';
            initializeForm();
        }

        window.displayOrders = function(filteredOrders = null) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            const ordersToDisplay = filteredOrders || orders;

            if (ordersToDisplay.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª</td></tr>';
                return;
            }

            ordersToDisplay.forEach((order, index) => {
                const row = tbody.insertRow();
                const date = new Date(order.orderDate);
                const formattedDate = date.toLocaleDateString('ar-EG') + ' ' + date.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                
                const orderTypeBadge = order.orderType === 'friends' ? 
                    '<span class="badge badge-friends">Ù…Ø¹Ø§Ø±Ù</span>' : 
                    order.orderType === 'online' ?
                    '<span class="badge badge-online">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</span>' : 
                    '<span class="badge badge-store">Ù…Ø­Ù„</span>';
                
                const saleMethodBadge = !order.saleMethod ? '-' :
                    order.saleMethod === 'wholesale' ? 
                    '<span class="badge badge-wholesale">Ø¬Ù…Ù„Ø©</span>' : 
                    '<span class="badge badge-consignment">Ø£Ù…Ø§Ù†Ø©</span>';

                row.innerHTML = `
                    <td>${order.orderNumber}</td>
                    <td>${formattedDate}</td>
                    <td>${orderTypeBadge}</td>
                    <td>${saleMethodBadge}</td>
                    <td>${order.customerName}</td>
                    <td>${order.totalPrice.toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
                    <td>${order.netProfit.toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewOrderDetails(${index})">Ø¹Ø±Ø¶</button>
                        <button class="btn btn-danger" onclick="deleteOrder(${index})">Ø­Ø°Ù</button>
                    </td>
                `;
            });
        }

        window.filterOrders = function() {
            const orderType = document.getElementById('filterOrderType').value;
            const saleMethod = document.getElementById('filterSaleMethod').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            let filtered = orders.filter(order => {
                let match = true;

                if (orderType && order.orderType !== orderType) match = false;
                if (saleMethod && order.saleMethod !== saleMethod) match = false;
                
                if (dateFrom) {
                    const orderDate = new Date(order.orderDate).setHours(0,0,0,0);
                    const fromDate = new Date(dateFrom).setHours(0,0,0,0);
                    if (orderDate < fromDate) match = false;
                }
                
                if (dateTo) {
                    const orderDate = new Date(order.orderDate).setHours(0,0,0,0);
                    const toDate = new Date(dateTo).setHours(0,0,0,0);
                    if (orderDate > toDate) match = false;
                }

                return match;
            });

            displayOrders(filtered);
        }

        window.viewOrderDetails = function(index) {
            const order = orders[index];
            let productsDetails = '';
            
            order.products.forEach(product => {
                productsDetails += `\n- ${product.name}: ${product.quantity} Ã— ${product.price} = ${product.total.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
            });

            alert(`
ğŸ“¦ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±

Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±: ${order.orderNumber}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(order.orderDate).toLocaleString('ar-EG')}
Ø§Ù„Ù†ÙˆØ¹: ${order.orderType === 'friends' ? 'ØªØ³Ù„ÙŠÙ… Ù„Ù…Ø¹Ø§Ø±Ù' : order.orderType === 'online' ? 'Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†' : 'Ù…Ø­Ù„'}
${order.saleMethod ? 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨ÙŠØ¹: ' + (order.saleMethod === 'wholesale' ? 'Ø¬Ù…Ù„Ø©' : 'Ø£Ù…Ø§Ù†Ø©') + '\n' : ''}Ø§Ù„Ø¹Ù…ÙŠÙ„: ${order.customerName}

Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:${productsDetails}

Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±: ${order.totalPrice.toFixed(2)} Ø¬Ù†ÙŠÙ‡
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: ${order.totalCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡
${order.commissionAmount > 0 ? `Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø­Ù„ (${order.commissionRate}%): ${order.commissionAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡\nØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: ${order.netAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡\n` : ''}ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${order.netProfit.toFixed(2)} Ø¬Ù†ÙŠÙ‡

${order.notes ? 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ' + order.notes : ''}
            `);
        }

        window.deleteOrder = async function(index) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±ØŸ')) {
                orders.splice(index, 1);
                await saveData(); // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
                displayOrders();
                updateStatistics();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        window.updateStatistics = function() {
            const totalOrders = orders.length;
            const friendsOrders = orders.filter(o => o.orderType === 'friends').length;
            const onlineOrders = orders.filter(o => o.orderType === 'online').length;
            const storeOrders = orders.filter(o => o.orderType === 'store').length;
            
            const totalSales = orders.reduce((sum, o) => sum + o.totalPrice, 0);
            const totalProfit = orders.reduce((sum, o) => sum + o.netProfit, 0);
            
            const storeWholesale = orders.filter(o => o.orderType === 'store' && o.saleMethod === 'wholesale')
                .reduce((sum, o) => sum + o.netProfit, 0);
            const storeConsignment = orders.filter(o => o.orderType === 'store' && o.saleMethod === 'consignment')
                .reduce((sum, o) => sum + o.netProfit, 0);
            
            const wholesaleProfit = orders.filter(o => o.saleMethod === 'wholesale')
                .reduce((sum, o) => sum + o.netProfit, 0);
            const consignmentProfit = orders.filter(o => o.saleMethod === 'consignment')
                .reduce((sum, o) => sum + o.netProfit, 0);

            document.getElementById('statTotalOrders').textContent = totalOrders;
            document.getElementById('statFriendsOrders').textContent = friendsOrders;
            document.getElementById('statOnlineOrders').textContent = onlineOrders;
            document.getElementById('statStoreOrders').textContent = storeOrders;
            document.getElementById('statTotalSales').textContent = totalSales.toFixed(2);
            document.getElementById('statTotalProfit').textContent = totalProfit.toFixed(2);
            
            document.getElementById('statStoreWholesale').textContent = storeWholesale.toFixed(2);
            document.getElementById('statStoreConsignment').textContent = storeConsignment.toFixed(2);
            
            document.getElementById('statWholesaleProfit').textContent = wholesaleProfit.toFixed(2);
            document.getElementById('statConsignmentProfit').textContent = consignmentProfit.toFixed(2);
        }

        // Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        window.clearAllData = async function() {
            if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ù† ØªØ³ØªØ·ÙŠØ¹ Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§!')) {
                try {
                    await window.storage.delete('orders_data');
                    orders = [];
                    orderCounter = 1;
                    displayOrders();
                    updateStatistics();
                    alert('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                }
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadData().then(() => {
            initializeForm();
            if (orders.length > 0) {
                console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${orders.length} Ø£ÙˆØ±Ø¯Ø± Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†`);
            }
        });
    </script>
</body>
</html>
